name: Test GKE Auth Plugin Installation
          
on:
  workflow_dispatch:   
          
jobs:
  test-install:
    runs-on: ubuntu-latest
          
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
          
      - name: Install Google Cloud CLI, Kubectl, and GKE Auth Plugin
        run: |
          # 0. Instalar herramientas base
          sudo apt-get update
          sudo apt-get install -y apt-transport-https ca-certificates gnupg curl openssl
          
          # 1. IMPORTAR CLAVE PÚBLICA (Método moderno de Google: Debian 9+/Ubuntu 18.04+)
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | \
            sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
            
          # 2. AÑADIR REPOSITORIO DE GOOGLE CLOUD (Usando signed-by para seguridad)
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | \
            sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
            
          # 3. ACTUALIZAR E INSTALAR EL CLI PRINCIPAL (google-cloud-cli)
          sudo apt-get update
          sudo apt-get install -y google-cloud-cli
          
          # 4. INSTALAR KUBECTL (Componente esencial que no viene con el CLI principal)
          sudo apt-get install -y kubectl
          
          # 5. INSTALAR EL PLUGIN DE AUTENTICACIÓN GKE (Componente adicional)
          # NOTA: La documentación menciona apt-get install google-cloud-sdk-gke-gcloud-auth-plugin,
          # pero este nombre a menudo falla o es inconsistente. Usaremos el nombre oficial:
          sudo apt-get install -y google-cloud-cli-gke-gcloud-auth-plugin
          
          # 6. EXPORTAR VARIABLE (Para usar el plugin de forma predeterminada)
          echo "export USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV
      - name: Verify installations
        run: |
          echo "Checking versions..."
          kubectl version --client
          gcloud version
          
          # Verifica la existencia del binario del plugin
          if command -v gke-gcloud-auth-plugin >/dev/null 2>&1; then
            echo "✅ gke-gcloud-auth-plugin is installed!"
          else
            echo "❌ gke-gcloud-auth-plugin is NOT installed!"
            exit 1
          fi
