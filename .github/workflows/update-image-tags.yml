name: Update Helm Chart Image Tags

on:
  repository_dispatch:
    types: 
      - update-image-tags 

jobs:
  update-chart-values:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Chart Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CHARTS_REPO_TOKEN }}

      - name: Install yq and jq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq && sudo chmod +x /usr/local/bin/yq
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Update Image Details in Target Values File (Blue/Green version)
        id: update_values
        run: |
          TARGET_VALUES_FILE_NAME="${{ github.event.client_payload.target_values_file }}"
          IMAGE_VERSION_TAG="${{ github.event.client_payload.image_version_tag }}"
          IMAGE_REGISTRY_BASE="${{ github.event.client_payload.image_registry_base }}"
          SERVICES_JSON_STRING='${{ toJSON(github.event.client_payload.services_to_update) }}'
      
          VALUES_FILE_PATH="ecommerce-app/${TARGET_VALUES_FILE_NAME}"
      
          if [ ! -f "$VALUES_FILE_PATH" ]; then
            echo "::error::Values file '$VALUES_FILE_PATH' not found."
            exit 1
          fi
      
          # Lista de servicios que deben usar Blue/Green
          SERVICES_WITH_BLUE_GREEN=("service-discovery" "cloud-config")
      
          echo "$SERVICES_JSON_STRING" | jq -r '.[]' | while read -r service_name; do
            [ -z "$service_name" ] && continue
            
            FULL_IMAGE_PATH="${IMAGE_REGISTRY_BASE}/${service_name}"
            NEW_TAG="${IMAGE_VERSION_TAG}"
      
            # Verificar si el servicio está en la lista de Blue/Green
            if [[ " ${SERVICES_WITH_BLUE_GREEN[@]} " =~ " ${service_name} " ]]; then
              echo "Servicio ${service_name} usa Blue/Green. Actualizando ambos..."
              # Crear la sección blue/green si no existe
              yq eval ".${service_name}.blue.repository = \"${FULL_IMAGE_PATH}\"" -i "${VALUES_FILE_PATH}"
              yq eval ".${service_name}.blue.tag = \"${NEW_TAG}\"" -i "${VALUES_FILE_PATH}"
              yq eval ".${service_name}.green.repository = \"${FULL_IMAGE_PATH}\"" -i "${VALUES_FILE_PATH}"
              yq eval ".${service_name}.green.tag = \"${NEW_TAG}\"" -i "${VALUES_FILE_PATH}"
            else
              echo "Servicio ${service_name} NO usa Blue/Green. Actualizando tag estándar..."
              yq eval ".${service_name}.image.repository = \"${FULL_IMAGE_PATH}\"" -i "${VALUES_FILE_PATH}"
              yq eval ".${service_name}.image.tag = \"${NEW_TAG}\"" -i "${VALUES_FILE_PATH}"
            fi
          done
      
          echo "Image updates complete for ${VALUES_FILE_PATH}."
          echo "VALUES_FILE_TO_COMMIT=${VALUES_FILE_PATH}" >> $GITHUB_ENV


      - name: Commit and Push Changes
        env:
          VALUES_FILE_FOR_GIT: ${{ env.VALUES_FILE_TO_COMMIT }}
          EVENT_ACTION_FOR_COMMIT: ${{ github.event.action }}
          IMAGE_VERSION_FOR_COMMIT: ${{ github.event.client_payload.image_version_tag }}
          EFFECTIVE_BRANCH_FOR_COMMIT: ${{ github.event.client_payload.effective_branch }}
          GH_TOKEN: ${{ secrets.CHARTS_REPO_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          if [ -z "${VALUES_FILE_FOR_GIT}" ]; then echo "::error::VALUES_FILE_FOR_GIT is empty."; exit 1; fi

          if ! git diff --quiet "${VALUES_FILE_FOR_GIT}"; then
            echo "Changes detected in '${VALUES_FILE_FOR_GIT}'. Committing..."
            git add "${VALUES_FILE_FOR_GIT}"
            COMMIT_MESSAGE="CI: Update ${VALUES_FILE_FOR_GIT} to version ${IMAGE_VERSION_FOR_COMMIT}
            Triggered by '${EVENT_ACTION_FOR_COMMIT}' on branch '${EFFECTIVE_BRANCH_FOR_COMMIT}'"
            git commit -m "$COMMIT_MESSAGE"
            
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            
            REMOTE_URL="https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
            git push "${REMOTE_URL}" "HEAD:${CURRENT_BRANCH}"
            
            echo "Changes successfully committed and pushed to ${CURRENT_BRANCH} for ${VALUES_FILE_FOR_GIT}."
          else
            echo "No changes detected in '${VALUES_FILE_FOR_GIT}'. Nothing to commit."
          fi
